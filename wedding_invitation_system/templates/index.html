{% extends "base.html" %}

{% block content %}
<div class="wedding-header">
    <h1><i class="fas fa-rings-wedding"></i> 注专转  转 转</h1>
    <p class="lead">专  注专转  转拽转 砖</p>
</div>

<div class="row">
    <div class="col-md-3">
        <div class="stat-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4>{{ total_guests }}</h4>
                    <p class="mb-0">住  专</p>
                </div>
                <i class="fas fa-users fa-2x opacity-75"></i>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card success">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4>{{ confirmed_guests }}</h4>
                    <p class="mb-0">砖专 注</p>
                </div>
                <i class="fas fa-check-circle fa-2x opacity-75"></i>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card info">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4>{{ total_attending }}</h4>
                    <p class="mb-0">住 注</p>
                </div>
                <i class="fas fa-user-friends fa-2x opacity-75"></i>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card warning">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4>{{ pending_responses }}</h4>
                    <p class="mb-0">转 转</p>
                </div>
                <i class="fas fa-clock fa-2x opacity-75"></i>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-pie"></i> 住住拽转  转</h5>
            </div>
            <div class="card-body">
                <canvas id="guestChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-tasks"></i> 驻注转 专转</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('add_guest') }}" class="btn btn-primary">
                        <i class="fas fa-user-plus"></i> 住驻转 专 砖
                    </a>
                    <button onclick="sendInvitations()" class="btn btn-success">
                        <i class="fab fa-whatsapp"></i> 砖转 转 WhatsApp
                    </button>
                    <button onclick="sendReminders()" class="btn btn-warning">
                        <i class="fas fa-bell"></i> 砖转 转专转
                    </button>
                    <button onclick="generateLinks()" class="btn btn-info">
                        <i class="fas fa-link"></i> 爪专转 拽砖专
                    </button>
                    <a href="{{ url_for('seating_chart') }}" class="btn btn-info">
                        <i class="fas fa-chair"></i> 住专 砖
                    </a>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> 专转 砖砖</h5>
            </div>
            <div class="card-body">
                <ol class="small">
                    <li>住祝 专 注专转</li>
                    <li>专 转 驻专 Twilio -.env</li>
                    <li>砖 转 专 WhatsApp</li>
                    <li>注拽 专 转转</li>
                    <li>转 住专 砖</li>
                </ol>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// 注转 转 专祝
fetch('/api/guest_stats')
    .then(response => response.json())
    .then(data => {
        const ctx = document.getElementById('guestChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['砖专 注', ' 注', '转 转'],
                datasets: [{
                    data: [data.confirmed, data.declined, data.pending],
                    backgroundColor: [
                        '#28a745',
                        '#dc3545',
                        '#ffc107'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    });

function sendInvitations() {
    if (confirm(' 转  砖专爪 砖 转  专?\n\n 驻转  Chrome 砖 转专 爪驻 .')) {
        // 爪转 专转 砖转砖
        showInstructions('转');
        
        // 驻注转 
        fetch('/api/send_invitations', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('转 砖 转! 拽 转 专 注.');
            } else {
                alert('砖: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('砖 驻注转 ');
        });
    }
}

function sendReminders() {
    if (confirm(' 转  砖专爪 砖 转专转 专 砖 ?')) {
        showInstructions('转专转');
        
        fetch('/api/send_reminders', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('转 砖转 转专转 转!');
            } else {
                alert('砖: ' + data.message);
            }
        });
    }
}

function generateLinks() {
    if (confirm(' 专爪 爪专 专砖转 拽砖专  专?')) {
        fetch('/api/generate_links', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 驻转转  砖 注 拽砖专
                const newWindow = window.open('', '_blank', 'width=800,height=600');
                newWindow.document.write(`
                    <html dir="rtl">
                    <head>
                        <title>拽砖专 专</title>
                        <style>
                            body { font-family: Arial; padding: 20px; }
                            .guest { margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
                            .link { color: blue; text-decoration: none; }
                            .copy-btn { margin-left: 10px; padding: 5px 10px; }
                        </style>
                    </head>
                    <body>
                        <h2>拽砖专  专</h2>
                        ${data.links.map(guest => `
                            <div class="guest">
                                <strong>${guest.name}</strong> (${guest.phone}) - ${guest.invited_count} <br>
                                <a href="${guest.link}" target="_blank" class="link">${guest.link}</a>
                                <button onclick="navigator.clipboard.writeText('${guest.link}')" class="copy-btn">注转拽</button>
                                <br>
                                <a href="https://wa.me/${guest.clean_phone}?text=${encodeURIComponent('砖 ' + guest.name + '!  拽砖专 砖专 注 转: ' + guest.link)}" target="_blank">
                                     砖 爪驻
                                </a>
                            </div>
                        `).join('')}
                    </body>
                    </html>
                `);
            } else {
                alert('砖 爪专转 拽砖专');
            }
        });
    }
}

function showInstructions(type) {
    const instructions = type === '转' ? 
        '专转 砖转 转:\n\n1. 驻转  Chrome 砖\n2. 住专拽 QR code 爪驻\n3.  转 砖 注转\n4.  转住专 转  注 住' :
        '专转 砖转 转专转:\n\n1.  驻砖 爪\' 拽\n2. 砖 转专转 专 砖 \n3. 转 注爪专  注转';
    
    alert(instructions);
}

// 注 住住拽转  30 砖转
setInterval(() => {
    location.reload();
}, 30000);
</script>
{% endblock %}